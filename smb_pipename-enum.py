import os
import subprocess
import sys

# A simple script to enumerate open pipenames on Windows systems running SMB.

# How to use:
## sudo apt install smbclient/kali-rolling
## python3 smb-pipenames-enum.py 10.10.10.1

if len(sys.argv) != 2:
    print ("Usage: python3 smb-pipenames-enum.py <ip addr>")
    sys.exit(0)

pipes  = [
    "netlogon",
    "lsarpc",
    "samr",
    "browser",
    "atsvc",
    "DAV RPC SERVICE",
    "epmapper",
    "eventlog",
    "InitShutdown",
    "keysvc",
    "lsass",
    "LSM_API_service",
    "ntsvcs",
    "plugplay",
    "protected_storage",
    "router",
    "SapiServerPipeS-1-5-5-0-70123",
    "scerpc",
    "srvsvc",
    "tapsrv",
    "trkwks",
    "W32TIME_ALT",
    "wkssvc",
    "PIPE_EVENTROOT\CIMV2SCM EVENT PROVIDER",
    "db2remotecmd"
]

open_pipes = []

for pipe in pipes:
    command = 'smbclient -N //' + sys.argv[1] + '/IPC$ -c \'open "' + pipe + '"\''
    result = subprocess.Popen(command, shell=True, stdout=subprocess.PIPE)
    if result.stdout.read(1) == 'o':
        open_pipes.append(pipe)

print("Useable pipes:")
for pipe in open_pipes:
    print("- " + pipe)
